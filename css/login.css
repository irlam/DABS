<?php
/**
 * Daily Activity Briefing System (DABS) - Login Page
 * 
 * This file provides the authentication gateway for the DABS application.
 * It handles user login verification, session management, and security features
 * including password hashing, brute force protection, and secure redirection.
 * 
 * Features:
 * - Secure authentication using password hashing
 * - Login attempt limiting to prevent brute force attacks
 * - Remember me functionality
 * - Password reset request handling
 * - Responsive design for all device sizes
 * - UK date/time formatting (DD/MM/YYYY)
 * 
 * @author irlamkeep
 * @version 1.0
 * @date 28/05/2025
 * @website dabs.defecttracker.uk
 */

// Start session for login tracking
session_start();

// Include database connection and utility functions
require_once 'includes/db_connect.php';
require_once 'includes/functions.php';

// Set default timezone to UTC
date_default_timezone_set('UTC');

// Initialize variables
$username = '';
$error = '';
$success = '';
$showResetForm = false;

// Get current date and time in UK format (DD/MM/YYYY HH:MM:SS)
$currentDateTime = date('d/m/Y H:i:s');

/**
 * Process login form submission
 */
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action']) && $_POST['action'] === 'login') {
    // Retrieve and sanitize submitted username and password
    $username = trim($_POST['username']);
    $password = $_POST['password'];
    $rememberMe = isset($_POST['remember_me']);
    
    // Validate input
    if (empty($username) || empty($password)) {
        $error = 'Please enter both username and password.';
    } else {
        // Check if login attempts are locked
        if (isAccountLocked($username)) {
            $error = 'Too many failed login attempts. Please try again after 15 minutes or reset your password.';
            logUserActivity('login_locked', "Account locked due to multiple failed attempts: $username");
        } else {
            // Attempt to authenticate user
            $user = authenticateUser($username, $password);
            
            if ($user) {
                // Login successful
                // Set session variables
                $_SESSION['user_id'] = $user['id'];
                $_SESSION['user_name'] = $user['name'];
                $_SESSION['user_role'] = $user['role'];
                $_SESSION['authenticated'] = true;
                $_SESSION['last_activity'] = time();
                
                // Set remember me cookie if requested
                if ($rememberMe) {
                    $token = generateRememberToken();
                    storeRememberToken($user['id'], $token);
                    
                    // Set secure cookie with 30-day expiration
                    setcookie(
                        'dabs_remember',
                        $user['id'] . ':' . $token,
                        [
                            'expires' => time() + (86400 * 30),
                            'path' => '/',
                            'domain' => '',
                            'secure' => true,
                            'httponly' => true,
                            'samesite' => 'Strict'
                        ]
                    );
                }
                
                // Update last login timestamp
                updateLastLogin($user['id']);
                
                // Log successful login
                logUserActivity('login_success', 'User logged in successfully', $user['id']);
                
                // Redirect to dashboard
                header('Location: index.php');
                exit;
            } else {
                // Login failed - record failed attempt
                recordFailedLogin($username);
                $error = 'Invalid username or password.';
                logUserActivity('login_failed', "Failed login attempt for username: $username");
            }
        }
    }
}

/**
 * Process password reset request
 */
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action']) && $_POST['action'] === 'reset') {
    $resetEmail = trim($_POST['reset_email']);
    
    if (empty($resetEmail)) {
        $error = 'Please enter your email address.';
    } else {
        // Check if email exists in database
        $user = getUserByEmail($resetEmail);
        
        if ($user) {
            // Generate password reset token
            $resetToken = bin2hex(random_bytes(32));
            $tokenExpiry = date('Y-m-d H:i:s', strtotime('+1 hour'));
            
            // Store token in database
            storeResetToken($user['id'], $resetToken, $tokenExpiry);
            
            // Send password reset email
            $resetLink = 'https://dabs.defecttracker.uk/reset_password.php?token=' . $resetToken;
            $emailSent = sendPasswordResetEmail($resetEmail, $user['name'], $resetLink);
            
            if ($emailSent) {
                $success = 'Password reset instructions have been sent to your email.';
                logUserActivity('password_reset_requested', "Reset request for email: $resetEmail");
            } else {
                $error = 'Could not send password reset email. Please contact support.';
            }
        } else {
            // Don't reveal that email doesn't exist for security
            $success = 'If your email address exists in our system, you will receive password reset instructions.';
        }
    }
}

/**
 * Check if account is locked due to too many failed attempts
 * 
 * @param string $username The username to check
 * @return bool True if account is locked, false otherwise
 */
function isAccountLocked($username) {
    // Get failed login attempts within the past 15 minutes
    $sql = "SELECT COUNT(*) as attempt_count FROM login_attempts 
            WHERE username = ? AND attempt_time > DATE_SUB(NOW(), INTERVAL 15 MINUTE)";
    $result = fetchOne($sql, [$username]);
    
    // Lock account after 5 failed attempts
    return $result && $result['attempt_count'] >= 5;
}

/**
 * Record a failed login attempt
 * 
 * @param string $username The username with failed login
 */
function recordFailedLogin($username) {
    $data = [
        'username' => $username,
        'ip_address' => $_SERVER['REMOTE_ADDR'],
        'attempt_time' => date('Y-m-d H:i:s')
    ];
    
    insertData('login_attempts', $data);
}

/**
 * Authenticate user with provided credentials
 * 
 * @param string $username The username
 * @param string $password The password
 * @return array|bool User data if authenticated, false otherwise
 */
function authenticateUser($username, $password) {
    // Get user by username
    $sql = "SELECT * FROM users WHERE username = ?";
    $user = fetchOne($sql, [$username]);
    
    // Verify password if user exists
    if ($user && password_verify($password, $user['password'])) {
        return $user;
    }
    
    return false;
}

/**
 * Update user's last login timestamp
 * 
 * @param int $userId User ID
 */
function updateLastLogin($userId) {
    $data = [
        'last_login' => date('Y-m-d H:i:s')
    ];
    
    updateData('users', $data, 'id = ?', [$userId]);
}

/**
 * Generate a secure token for remember me functionality
 * 
 * @return string A secure random token
 */
function generateRememberToken() {
    return bin2hex(random_bytes(32));
}

/**
 * Store the remember me token in the database
 * 
 * @param int $userId User ID
 * @param string $token The token to store
 */
function storeRememberToken($userId, $token) {
    // Delete any existing tokens for this user
    deleteData('remember_tokens', 'user_id = ?', [$userId]);
    
    // Store new token
    $data = [
        'user_id' => $userId,
        'token' => $token,
        'expires_at' => date('Y-m-d H:i:s', time() + (86400 * 30)) // 30 days
    ];
    
    insertData('remember_tokens', $data);
}

/**
 * Get user by email address
 * 
 * @param string $email Email address
 * @return array|bool User data if found, false otherwise
 */
function getUserByEmail($email) {
    $sql = "SELECT * FROM users WHERE email = ?";
    return fetchOne($sql, [$email]);
}

/**
 * Store a password reset token
 * 
 * @param int $userId User ID
 * @param string $token Reset token
 * @param string $expiry Token expiry datetime
 */
function storeResetToken($userId, $token, $expiry) {
    // Delete any existing tokens for this user
    deleteData('password_resets', 'user_id = ?', [$userId]);
    
    // Store new token
    $data = [
        'user_id' => $userId,
        'token' => $token,
        'expires_at' => $expiry
    ];
    
    insertData('password_resets', $data);
}

/**
 * Send password reset email
 * 
 * @param string $email Recipient email
 * @param string $name Recipient name
 * @param string $resetLink Password reset link
 * @return bool Success or failure
 */
function sendPasswordResetEmail($email, $name, $resetLink) {
    $subject = 'DABS Password Reset Request';
    
    $message = '<html>
    <head>
        <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
            .header { background-color: #2c3e50; color: white; padding: 20px; text-align: center; }
            .content { padding: 20px; background-color: #f9f9f9; }
            .button { background-color: #3498db; color: white; padding: 12px 20px; 
                    text-decoration: none; border-radius: 4px; display: inline-block; margin-top: 20px; }
            .footer { text-align: center; font-size: 12px; color: #888; margin-top: 30px; }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>Password Reset Request</h1>
            </div>
            <div class="content">
                <p>Hello ' . htmlspecialchars($name) . ',</p>
                <p>We received a request to reset your password for the Daily Activity Briefing System.</p>
                <p>To reset your password, please click the link below:</p>
                <p><a href="' . $resetLink . '" class="button">Reset Password</a></p>
                <p>This link will expire in 1 hour.</p>
                <p>If you did not request a password reset, please ignore this email or contact support.</p>
            </div>
            <div class="footer">
                <p>This is an automated email from the Daily Activity Briefing System.</p>
                <p>Date and time of request: ' . date('d/m/Y H:i:s') . '</p>
            </div>
        </div>
    </body>
    </html>';
    
    // Headers for HTML email
    $headers = [
        'MIME-Version: 1.0',
        'Content-type: text/html; charset=utf-8',
        'From: DABS <no-reply@defecttracker.uk>',
        'Reply-To: no-reply@defecttracker.uk',
        'X-Mailer: PHP/' . phpversion()
    ];
    
    // Send email
    return mail($email, $subject, $message, implode("\r\n", $headers));
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DABS - Login</title>
    
    <!-- Modern CSS Framework -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="css/styles.css" rel="stylesheet">
    <link href="css/login.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Inline critical styles for faster loading */
        body {
            background-color: #f5f7fa;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-container {
            max-width: 420px;
            width: 100%;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .logo-container {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            max-height: 80px;
            margin-bottom: 15px;
        }
        
        .toggle-form {
            color: #3498db;
            cursor: pointer;
        }
        
        .date-display {
            font-size: 0.9rem;
            color: #666;
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <!-- Logo and App Name -->
        <div class="logo-container">
            <img src="images/logo.png" alt="DABS Logo" class="logo">
            <h1>Daily Activity Briefing System</h1>
            <div class="date-display">
                <?php echo $currentDateTime; ?>
            </div>
        </div>
        
        <?php if ($error): ?>
            <div class="alert alert-danger"><?php echo $error; ?></div>
        <?php endif; ?>
        
        <?php if ($success): ?>
            <div class="alert alert-success"><?php echo $success; ?></div>
        <?php endif; ?>
        
        <!-- Login Form -->
        <div id="loginForm" class="<?php echo $showResetForm ? 'd-none' : ''; ?>">
            <form method="POST" action="">
                <input type="hidden" name="action" value="login">
                
                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control" id="username" name="username" 
                           value="<?php echo htmlspecialchars($username); ?>" required>
                </div>
                
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="password" name="password" required>
                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="rememberMe" name="remember_me">
                    <label class="form-check-label" for="rememberMe">Remember me</label>
                </div>
                
                <button type="submit" class="btn btn-primary w-100">Log In</button>
                
                <div class="mt-3 text-center">
                    <a href="#" class="toggle-form" id="showResetForm">Forgot password?</a>
                </div>
            </form>
        </div>
        
        <!-- Password Reset Form -->
        <div id="resetForm" class="<?php echo $showResetForm ? '' : 'd-none'; ?>">
            <form method="POST" action="">
                <input type="hidden" name="action" value="reset">
                
                <div class="mb-3">
                    <label for="resetEmail" class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="resetEmail" name="reset_email" required>
                </div>
                
                <button type="submit" class="btn btn-primary w-100">Request Password Reset</button>
                
                <div class="mt-3 text-center">
                    <a href="#" class="toggle-form" id="showLoginForm">Back to login</a>
                </div>
            </form>
        </div>
        
        <!-- System Information -->
        <div class="system-info text-center mt-4">
            <small>DABS v1.0 | &copy; 2025 DefectTracker UK</small>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Toggle password visibility
        document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            const icon = this.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
        
        // Toggle between login and password reset forms
        document.getElementById('showResetForm').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('loginForm').classList.add('d-none');
            document.getElementById('resetForm').classList.remove('d-none');
        });
        
        document.getElementById('showLoginForm').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('resetForm').classList.add('d-none');
            document.getElementById('loginForm').classList.remove('d-none');
        });
    </script>
</body>
</html>